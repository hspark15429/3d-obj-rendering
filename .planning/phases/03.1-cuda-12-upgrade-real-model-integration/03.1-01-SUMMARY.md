---
phase: 03.1-cuda-12-upgrade-real-model-integration
plan: 01
subsystem: infra
tags: [cuda, pytorch, docker, nvdiffrast, gpu]

# Dependency graph
requires:
  - phase: 03-model-integration
    provides: CUDA 11.8 + PyTorch 2.1 Docker infrastructure
provides:
  - CUDA 12.1 base Docker image
  - PyTorch 2.4.1 with cu121 wheels
  - numpy<2 pin for ABI compatibility
  - Updated TORCH_CUDA_ARCH_LIST for newer GPUs
affects: [03.1-02, 03.1-03, 03.1-04, 03.1-05, 03.1-06]

# Tech tracking
tech-stack:
  added: [CUDA 12.1, PyTorch 2.4.1, torchvision 0.19.1, torchaudio 2.4.1]
  patterns: [CUDA-first pip install, numpy version pinning]

key-files:
  created: [scripts/verify-cuda-stack.sh]
  modified: [Dockerfile, requirements.txt]

key-decisions:
  - "CUDA 12.1.1 over 12.4 - better spconv-cu120 compatibility"
  - "PyTorch 2.4.1 over 2.4.0 - latest stable with cu121 wheels"
  - "Removed PyTorch3D wheel - cu118 incompatible, addressed in 03.1-02"
  - "TORCH_CUDA_ARCH_LIST 7.0-9.0 - includes Ada Lovelace and Hopper"

patterns-established:
  - "CUDA version pinning: Use specific CUDA version across all packages"
  - "numpy<2 requirement: Pin before installing CUDA extensions"

# Metrics
duration: 5min
completed: 2026-01-31
---

# Phase 3.1 Plan 01: CUDA 12.1 + PyTorch 2.4.1 Infrastructure Upgrade Summary

**Docker base image upgraded to CUDA 12.1 with PyTorch 2.4.1 and numpy<2 pin for ReconViaGen dependency compatibility**

## Performance

- **Duration:** 5 min
- **Started:** 2026-01-31T05:33:18Z
- **Completed:** 2026-01-31T05:38:05Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- Upgraded Dockerfile from CUDA 11.8 to CUDA 12.1.1 base image
- Updated PyTorch from 2.1.0+cu118 to 2.4.1 with cu121 wheels
- Pinned numpy<2 in both Dockerfile and requirements.txt for spconv/nvdiffrast ABI compatibility
- Removed incompatible PyTorch3D cu118 wheel (to be replaced in 03.1-02)
- Updated TORCH_CUDA_ARCH_LIST to support newer GPU architectures (8.9, 9.0)
- Created verification script for testing CUDA/PyTorch stack in Docker

## Task Commits

Each task was committed atomically:

1. **Task 1: Upgrade Dockerfile to CUDA 12.1 + PyTorch 2.4.1** - `6030312` (feat)
2. **Task 2: Update requirements.txt for CUDA 12 compatibility** - `35e2987` (feat)
3. **Task 3: Verify CUDA/PyTorch stack works** - `7ed1d59` (chore)

## Files Created/Modified

- `Dockerfile` - Upgraded base image, PyTorch version, removed PyTorch3D, updated arch list
- `requirements.txt` - Added numpy<2 pin, updated comments for CUDA 12.1
- `scripts/verify-cuda-stack.sh` - New verification script for Docker testing

## Decisions Made

1. **CUDA 12.1.1 base image** - Compatible with spconv-cu120 and PyTorch 2.4.x wheels
2. **PyTorch 2.4.1** - Latest stable version with CUDA 12.1 wheels available
3. **Removed PyTorch3D wheel** - cu118 wheel incompatible with cu121; trimesh + nvdiffrast alternative in Phase 03.1-02
4. **TORCH_CUDA_ARCH_LIST extended** - Added 8.9 (Ada Lovelace) and 9.0 (Hopper) for newer GPUs

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Created scripts directory for verification script**
- **Found during:** Task 3 (verification script creation)
- **Issue:** scripts/ directory did not exist
- **Fix:** Created directory with mkdir -p
- **Files modified:** scripts/verify-cuda-stack.sh (new)
- **Verification:** File created successfully
- **Committed in:** 7ed1d59 (Task 3 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Minor directory creation, no scope change.

## Issues Encountered

- **Docker daemon not accessible in execution environment** - Docker socket requires sudo or docker group membership. Verification script created for manual testing. Dockerfile syntax and content verified programmatically.

## User Setup Required

**Docker image build and verification required:**

```bash
# Build the updated Docker image
docker build -t 3d-recon-test:cuda12 .

# Verify CUDA/PyTorch stack (requires GPU)
docker run --gpus all --rm 3d-recon-test:cuda12 bash /app/scripts/verify-cuda-stack.sh

# Run existing tests
docker run --gpus all --rm 3d-recon-test:cuda12 pytest tests/ -v
```

## Next Phase Readiness

- **Ready:** CUDA 12.1 + PyTorch 2.4.1 base infrastructure in place
- **Next:** 03.1-02 will add ReconViaGen dependencies (spconv-cu120, xformers, flash-attn)
- **Note:** PyTorch3D replaced with trimesh+nvdiffrast in Phase 3.1-02
- **Blocker:** Docker build verification pending (requires GPU access)

---
*Phase: 03.1-cuda-12-upgrade-real-model-integration*
*Completed: 2026-01-31*
