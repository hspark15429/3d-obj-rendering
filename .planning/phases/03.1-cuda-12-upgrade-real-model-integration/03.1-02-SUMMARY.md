---
phase: 03.1-cuda-12-upgrade-real-model-integration
plan: 02
subsystem: infra
tags: [trellis, spconv, xformers, flash-attn, reconviagen, docker]

# Dependency graph
requires:
  - phase: 03.1-01
    provides: CUDA 12.1 + PyTorch 2.4.1 base Docker image
provides:
  - TRELLIS dependencies in Dockerfile (spconv-cu120, xformers, flash-attn)
  - estheryang11/ReconViaGen code cloned with TRELLIS submodule
  - TrellisPipelineWrapper class for model loading/inference
  - SPCONV_ALGO=native environment variable set
affects: [03.1-03, 03.1-04, 03.1-05]

# Tech tracking
tech-stack:
  added: [spconv-cu120 2.3.6, xformers 0.0.27.post2, flash-attn 2.7.0.post2, transformers 4.46.3, einops 0.8.1, huggingface_hub 0.33.4]
  patterns: [lazy pipeline loading, SPCONV_ALGO env before imports]

key-files:
  created: [app/models/trellis/__init__.py, app/models/trellis/pipeline.py, scripts/verify-trellis-deps.sh]
  modified: [Dockerfile]

key-decisions:
  - "Pre-built flash-attn wheel over source compilation - source takes hours and often fails"
  - "SPCONV_ALGO=native set in both Dockerfile ENV and Python module - critical for spconv"
  - "Clone estheryang11/ReconViaGen with --recursive flag - includes TRELLIS as submodule"
  - "Lazy pipeline import via load() method - defers heavy imports until needed"

patterns-established:
  - "TrellisPipelineWrapper pattern: load/run/cleanup lifecycle for GPU memory management"
  - "Set SPCONV_ALGO before any trellis imports to avoid crashes"

# Metrics
duration: 3min
completed: 2026-01-31
---

# Phase 3.1 Plan 02: TRELLIS Dependencies and Pipeline Wrapper Summary

**TRELLIS/ReconViaGen dependencies installed in Dockerfile with TrellisPipelineWrapper class for lazy model loading**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-31T05:40:46Z
- **Completed:** 2026-01-31T05:43:16Z
- **Tasks:** 3
- **Files created:** 3
- **Files modified:** 1

## Accomplishments
- Dockerfile updated with all TRELLIS dependencies (spconv-cu120, xformers, flash-attn, transformers, einops, huggingface_hub)
- estheryang11/ReconViaGen cloned with --recursive flag (includes TRELLIS submodule)
- TrellisPipelineWrapper created with load/run/cleanup interface for VRAM management
- Verification script created for Docker container testing

## Task Commits

Each task was committed atomically:

1. **Task 1: Add TRELLIS dependencies to Dockerfile** - `cf2dcd4` (feat)
2. **Task 2: Create TRELLIS pipeline wrapper module** - `1ea81d5` (feat)
3. **Task 3: Verify TRELLIS dependencies work together** - `28b765e` (chore)

## Files Created/Modified

- `Dockerfile` - Added TRELLIS dependencies: spconv-cu120, xformers, flash-attn wheel, transformers, einops, huggingface_hub; clones estheryang11/ReconViaGen; sets SPCONV_ALGO=native
- `app/models/trellis/__init__.py` - Module init exposing TrellisPipelineWrapper
- `app/models/trellis/pipeline.py` - 134-line wrapper with lazy loading, configurable inference params, cleanup for VRAM
- `scripts/verify-trellis-deps.sh` - Container verification script for spconv, flash-attn, TRELLIS imports

## Decisions Made

1. **Pre-built flash-attn wheel** - Building from source takes 1+ hours and often fails with OOM; pre-built wheel for cu12+torch2.4 is reliable
2. **SPCONV_ALGO=native in multiple places** - Set in Dockerfile ENV and in pipeline.py before imports; redundancy ensures it's always set
3. **Clone with --recursive flag** - estheryang11/ReconViaGen includes TRELLIS as a git submodule
4. **Lazy pipeline loading** - TrellisPipelineWrapper defers heavy imports to load() method, allowing faster module initialization

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Docker not accessible in execution environment**
- **Found during:** Task 1 and Task 3 verification
- **Issue:** Docker daemon socket not accessible (permission denied, no sudo access)
- **Fix:** Created verification script (scripts/verify-trellis-deps.sh) for later execution in container
- **Impact:** Docker build verification deferred; script provided for user to run when Docker available
- **Verification:** Python syntax checks passed; module structure verified

---

**Total deviations:** 1 blocking (Docker access)
**Impact on plan:** Dockerfile changes syntactically correct; verification deferred to container runtime. No functional impact on artifacts.

## Issues Encountered

- Docker daemon not accessible in this execution environment - created verification script to be run later in container

## User Setup Required

To verify TRELLIS dependencies after Docker build:
```bash
# Build the image
docker build -t 3d-recon-test:trellis .

# Run verification script
docker run --gpus all --rm 3d-recon-test:trellis /app/scripts/verify-trellis-deps.sh
```

## Next Phase Readiness

- Dockerfile ready for build with all TRELLIS dependencies
- TrellisPipelineWrapper ready for integration in reconviagen.py (03.1-03)
- Pipeline uses TrellisVGGTTo3DPipeline.from_pretrained() pattern
- SPCONV_ALGO environment properly configured

**Blockers:** None - Docker verification can be done independently

---
*Phase: 03.1-cuda-12-upgrade-real-model-integration*
*Completed: 2026-01-31*
