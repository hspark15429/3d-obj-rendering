---
phase: 04-quality-preview
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - app/services/quality_metrics.py
autonomous: true

must_haves:
  truths:
    - "PSNR can be computed between two images"
    - "SSIM can be computed between two images"
    - "Depth error metrics (MAE, RMSE) can be computed between depth maps"
    - "Quality status is classified as normal/warning/failure based on thresholds"
  artifacts:
    - path: "requirements.txt"
      provides: "scikit-image dependency"
      contains: "scikit-image"
    - path: "app/services/quality_metrics.py"
      provides: "PSNR, SSIM, depth error computation"
      exports: ["compute_psnr", "compute_ssim", "compute_depth_error", "classify_quality_status"]
      min_lines: 80
  key_links:
    - from: "app/services/quality_metrics.py"
      to: "skimage.metrics"
      via: "import"
      pattern: "from skimage.metrics import"
---

<objective>
Create quality metrics computation service with PSNR, SSIM, and depth error functions.

Purpose: Enable reconstruction quality assessment by comparing rendered output to input images. This is the foundation for the quality validation pipeline.

Output: quality_metrics.py service with compute_psnr(), compute_ssim(), compute_depth_error(), and classify_quality_status() functions.
</objective>

<execution_context>
@/home/devuser/.claude/get-shit-done/workflows/execute-plan.md
@/home/devuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quality-preview/04-CONTEXT.md
@.planning/phases/04-quality-preview/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scikit-image dependency</name>
  <files>requirements.txt</files>
  <action>
Add scikit-image>=0.26.0 to requirements.txt in the "3D processing" section.

Location: After the existing numpy/trimesh/Pillow/scipy entries.

scikit-image provides peak_signal_noise_ratio and structural_similarity functions for quality metrics.
  </action>
  <verify>grep "scikit-image" requirements.txt returns the version constraint</verify>
  <done>requirements.txt contains scikit-image>=0.26.0</done>
</task>

<task type="auto">
  <name>Task 2: Create quality_metrics.py service</name>
  <files>app/services/quality_metrics.py</files>
  <action>
Create app/services/quality_metrics.py with the following functions:

1. **load_image_float(path: Path) -> np.ndarray**
   - Load image as float32 array in [0, 1] range
   - Use PIL to load, convert to RGB, divide by 255.0

2. **compute_psnr(img_true: np.ndarray, img_test: np.ndarray) -> float**
   - Use skimage.metrics.peak_signal_noise_ratio
   - CRITICAL: Always specify data_range=1.0 for float images
   - Return PSNR in dB

3. **compute_ssim(img_true: np.ndarray, img_test: np.ndarray) -> float**
   - Use skimage.metrics.structural_similarity
   - CRITICAL: Always specify data_range=1.0 and channel_axis=-1 for RGB
   - Return SSIM score [0, 1]

4. **compute_depth_error(depth_true: np.ndarray, depth_pred: np.ndarray) -> dict**
   - Compute MAE and RMSE between depth maps
   - Create valid_mask = (depth_true > 0) & (depth_pred > 0)
   - Return {"mae": float, "rmse": float, "valid_pixels": int}

5. **compute_overall_metrics(image_pairs: List[Tuple[np.ndarray, np.ndarray]]) -> dict**
   - Compute PSNR and SSIM for each pair
   - Return averaged metrics: {"psnr": mean, "ssim": mean}

6. **classify_quality_status(psnr: float, ssim: float) -> str**
   - Apply thresholds from CONTEXT.md:
     - Normal: PSNR >= 25dB AND SSIM >= 0.85
     - Warning: PSNR >= 20dB AND SSIM >= 0.75 (but not normal)
     - Failure: Below warning thresholds
   - Return "normal", "warning", or "failure"

Include module docstring explaining the quality metrics and thresholds.
Add logging for metric computation.
  </action>
  <verify>
python -c "from app.services.quality_metrics import compute_psnr, compute_ssim, compute_depth_error, classify_quality_status; print('imports ok')"
  </verify>
  <done>
quality_metrics.py exists with all functions, imports work, thresholds match CONTEXT.md decisions
  </done>
</task>

</tasks>

<verification>
1. requirements.txt includes scikit-image>=0.26.0
2. app/services/quality_metrics.py exists with all required functions
3. Python imports work without error
4. Thresholds match Phase 4 CONTEXT.md: PSNR Normal>=25dB, Warning>=20dB; SSIM Normal>=0.85, Warning>=0.75
</verification>

<success_criteria>
- scikit-image dependency added to requirements.txt
- quality_metrics.py provides compute_psnr, compute_ssim, compute_depth_error, classify_quality_status
- All functions follow research patterns (data_range=1.0, channel_axis=-1, valid_mask for depth)
- Quality thresholds hardcoded per user decision (no runtime config)
</success_criteria>

<output>
After completion, create `.planning/phases/04-quality-preview/04-01-SUMMARY.md`
</output>
