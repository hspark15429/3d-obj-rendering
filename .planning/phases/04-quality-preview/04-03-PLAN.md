---
phase: 04-quality-preview
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - app/services/preview_generator.py
autonomous: true

must_haves:
  truths:
    - "Preview images are generated from 6 canonical angles"
    - "Both textured and wireframe previews are generated"
    - "Preview images are saved as PNG files"
    - "Quality metrics are computed by comparing renders to input images"
    - "Quality report is saved as quality.json"
  artifacts:
    - path: "app/services/preview_generator.py"
      provides: "Preview generation and quality report orchestration"
      exports: ["PreviewGenerator", "generate_previews", "generate_quality_report"]
      min_lines: 150
  key_links:
    - from: "app/services/preview_generator.py"
      to: "app/services/quality_metrics.py"
      via: "import"
      pattern: "from app.services.quality_metrics import"
    - from: "app/services/preview_generator.py"
      to: "app/services/mesh_renderer.py"
      via: "import"
      pattern: "from app.services.mesh_renderer import"
---

<objective>
Create preview generation service that renders preview images and computes quality reports.

Purpose: Orchestrate mesh rendering for preview images (textured + wireframe from 6 angles) and quality metric computation (PSNR/SSIM/depth comparison against input images).

Output: preview_generator.py service with PreviewGenerator class and generate_quality_report() function.
</objective>

<execution_context>
@/home/devuser/.claude/get-shit-done/workflows/execute-plan.md
@/home/devuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quality-preview/04-CONTEXT.md
@.planning/phases/04-quality-preview/04-RESEARCH.md
@.planning/phases/04-quality-preview/04-01-SUMMARY.md
@.planning/phases/04-quality-preview/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview_generator.py service</name>
  <files>app/services/preview_generator.py</files>
  <action>
Create app/services/preview_generator.py with preview generation and quality report capabilities:

1. **class PreviewGenerator:**
   - __init__(self, renderer: MeshRenderer = None):
     - Store or create MeshRenderer instance

   - generate_previews(self, mesh_path: Path, output_dir: Path, camera_poses: dict, resolution: Tuple[int, int]) -> dict:
     - Load mesh from GLB file
     - For each of 6 camera poses:
       - Render textured image, save as preview_textured_{i:02d}.png
       - Render wireframe image, save as preview_wireframe_{i:02d}.png
     - Return {"textured": [paths], "wireframe": [paths]}

   - compute_quality_metrics(self, mesh_path: Path, input_dir: Path, camera_poses: dict) -> dict:
     - Load input images from views_dir
     - Load input depth maps from depth_dir
     - For each camera pose:
       - Render mesh to match input view
       - Render depth map
       - Compute PSNR/SSIM between rendered and input image
       - Compute depth MAE/RMSE between rendered and input depth
     - Average all metrics using compute_overall_metrics()
     - Return {"psnr": float, "ssim": float, "depth_mae": float, "depth_rmse": float}

2. **generate_quality_report(job_id: str, model: str, metrics: dict, metadata: dict, output_path: Path) -> dict:**
   - Build quality.json structure per RESEARCH.md:
     ```python
     {
         "job_id": job_id,
         "model": model,
         "status": classify_quality_status(metrics["psnr"], metrics["ssim"]),
         "summary": f"Reconstruction quality: {status} (PSNR {psnr:.1f} dB, SSIM {ssim:.2f})",
         "metrics": {
             "psnr": metrics["psnr"],
             "ssim": metrics["ssim"],
             "depth_mae": metrics["depth_mae"],
             "depth_rmse": metrics["depth_rmse"]
         },
         "thresholds": {
             "psnr_normal": 25.0,
             "psnr_warning": 20.0,
             "ssim_normal": 0.85,
             "ssim_warning": 0.75
         },
         "metadata": {
             "timestamp": datetime.utcnow().isoformat() + "Z",
             "input_file": metadata.get("input_file"),
             "processing_duration_sec": metadata.get("duration"),
             "image_resolution": metadata.get("resolution"),
             "num_views": 6
         }
     }
     ```
   - Write to output_path as formatted JSON
   - Return the report dict

3. **generate_all(job_id: str, model: str, mesh_path: Path, input_dir: Path, output_dir: Path, metadata: dict) -> dict:**
   - Main entry point for quality pipeline
   - Load camera poses from input_dir/transforms_train.json
   - Extract resolution from first input image
   - Generate preview images
   - Compute quality metrics
   - Generate and save quality report
   - Return {"previews": paths, "quality_report": report, "status": status}

IMPORTANT per CONTEXT.md decisions:
- Resolution matches input image resolution
- PNG format for lossless compression
- Overall metrics only (averaged), no per-view breakdown
- Include human-readable summary text
- If rendering fails, job fails (no partial success)

Include logging for progress tracking.
  </action>
  <verify>
python -c "from app.services.preview_generator import PreviewGenerator, generate_quality_report; print('imports ok')"
  </verify>
  <done>
preview_generator.py exists with PreviewGenerator class and quality report generation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update services __init__.py for exports</name>
  <files>app/services/__init__.py</files>
  <action>
Update app/services/__init__.py to export new quality/preview services.

Add imports:
- from app.services.quality_metrics import compute_psnr, compute_ssim, compute_depth_error, classify_quality_status
- from app.services.mesh_renderer import MeshRenderer, load_camera_poses
- from app.services.preview_generator import PreviewGenerator, generate_quality_report

This enables clean imports like:
```python
from app.services import PreviewGenerator, classify_quality_status
```
  </action>
  <verify>
python -c "from app.services import PreviewGenerator, MeshRenderer, classify_quality_status; print('imports ok')"
  </verify>
  <done>app/services/__init__.py exports all new quality/preview functions</done>
</task>

</tasks>

<verification>
1. app/services/preview_generator.py exists with all required functions
2. Python imports work from app.services
3. PreviewGenerator.generate_previews() creates textured and wireframe images
4. generate_quality_report() creates properly formatted quality.json
5. generate_all() orchestrates the full pipeline
</verification>

<success_criteria>
- preview_generator.py provides PreviewGenerator class with generate_previews, compute_quality_metrics methods
- generate_quality_report() produces quality.json with status, metrics, thresholds, metadata
- Resolution extracted from input images (not hardcoded)
- 6 preview angles for both textured and wireframe
- Services are exported from app/services/__init__.py
</success_criteria>

<output>
After completion, create `.planning/phases/04-quality-preview/04-03-SUMMARY.md`
</output>
