---
phase: 05-results-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/error_codes.py
  - app/main.py
  - app/api/schemas.py
autonomous: true

must_haves:
  truths:
    - "All error responses follow structured JSON format with code, message, details, suggestion"
    - "HTTP status codes are semantically correct (422 validation, 404 not found, 409 conflict, 410 gone, 503 resource)"
    - "Error suggestions are actionable and specific to each error type"
  artifacts:
    - path: "app/api/error_codes.py"
      provides: "Centralized error code taxonomy"
      contains: "class ErrorCode"
    - path: "app/main.py"
      provides: "Global exception handlers"
      contains: "exception_handler"
    - path: "app/api/schemas.py"
      provides: "Error response schema"
      contains: "class ErrorDetail"
  key_links:
    - from: "app/main.py"
      to: "app/api/error_codes.py"
      via: "import ErrorCode, ERROR_SUGGESTIONS"
      pattern: "from app\\.api\\.error_codes import"
---

<objective>
Create centralized error handling infrastructure for Phase 5.

Purpose: Establish consistent error response format across all API endpoints. Per CONTEXT.md, all errors must use structured JSON with code, message, details, and suggestion fields.

Output:
- app/api/error_codes.py with ErrorCode enum and ERROR_SUGGESTIONS mapping
- Updated app/main.py with global exception handlers
- Updated app/api/schemas.py with ErrorDetail and ErrorResponse schemas
</objective>

<execution_context>
@/home/devuser/.claude/get-shit-done/workflows/execute-plan.md
@/home/devuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-results-error-handling/05-CONTEXT.md
@.planning/phases/05-results-error-handling/05-RESEARCH.md
@app/main.py
@app/api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error code taxonomy</name>
  <files>app/api/error_codes.py</files>
  <action>
Create app/api/error_codes.py with:

1. ErrorCode enum (str, Enum) containing all error codes per RESEARCH.md:
   - Validation: VALIDATION_FAILED, FILE_TOO_LARGE, INVALID_FILE_FORMAT, INVALID_FILE_COUNT
   - Not found: JOB_NOT_FOUND
   - State conflict: JOB_NOT_READY
   - Gone: JOB_EXPIRED
   - Model errors: MODEL_FAILED, MODEL_OOM, MODEL_VRAM_OOM, MODEL_CONVERGENCE_FAILED, QUALITY_THRESHOLD_FAILED, INCOMPLETE_RESULTS
   - Resource errors: GPU_UNAVAILABLE, DISK_FULL, MEMORY_EXHAUSTED
   - Generic: UNKNOWN_ERROR

2. ERROR_SUGGESTIONS dict mapping ErrorCode -> actionable suggestion string
   Per CONTEXT.md, suggestions must be specific:
   - FILE_TOO_LARGE: "Reduce image resolution or compress PNGs before uploading (max 20MB per file)."
   - MODEL_VRAM_OOM: "GPU ran out of VRAM (16GB limit). Try again when GPU resources are available."
   - QUALITY_THRESHOLD_FAILED: Include actual vs expected values hint

3. Helper function `make_error_detail(code, message, details=None) -> dict` that builds the structured error dict with suggestion lookup.
  </action>
  <verify>python -c "from app.api.error_codes import ErrorCode, ERROR_SUGGESTIONS, make_error_detail; print(make_error_detail(ErrorCode.FILE_TOO_LARGE, 'Test'))"</verify>
  <done>ErrorCode enum has 16+ codes, ERROR_SUGGESTIONS has entry for each code, make_error_detail returns dict with code/message/details/suggestion</done>
</task>

<task type="auto">
  <name>Task 2: Add error schemas and global exception handlers</name>
  <files>app/api/schemas.py, app/main.py</files>
  <action>
1. Update app/api/schemas.py - add ErrorDetail and ErrorResponse schemas:
   ```python
   class ErrorDetail(BaseModel):
       """Structured error detail per CONTEXT.md format."""
       code: str = Field(..., description="Error code (e.g., VALIDATION_FAILED)")
       message: str = Field(..., description="Human-readable error message")
       details: dict = Field(default_factory=dict, description="Additional context")
       suggestion: str = Field(..., description="Actionable fix hint")

   class ErrorResponse(BaseModel):
       """Error response wrapper."""
       error: ErrorDetail
   ```

2. Update app/main.py - add global exception handlers:

   a. Replace existing FileValidationError handler with structured format:
      - Import ErrorCode, make_error_detail from app.api.error_codes
      - Return 422 with structured error (VALIDATION_FAILED or specific code based on error)

   b. Add HTTPException handler that formats exc.detail as structured error:
      - If exc.detail is already a dict with "code" key, use it directly
      - Otherwise wrap in UNKNOWN_ERROR structure

   c. Add RequestValidationError handler (Pydantic validation):
      - Extract field errors from exc.errors()
      - Return 422 with VALIDATION_FAILED code and field details

   d. Add generic Exception handler for unhandled errors:
      - Log the error
      - Return 500 with UNKNOWN_ERROR (don't expose internal details)

Keep existing health endpoint and lifespan unchanged.
  </action>
  <verify>
python -c "from app.api.schemas import ErrorDetail, ErrorResponse; print(ErrorResponse(error=ErrorDetail(code='TEST', message='test', details={}, suggestion='test')).model_dump_json())"
  </verify>
  <done>ErrorDetail schema exists with 4 fields, main.py has 4 exception handlers (FileValidationError, HTTPException, RequestValidationError, Exception)</done>
</task>

</tasks>

<verification>
1. Import test: `python -c "from app.api.error_codes import ErrorCode, ERROR_SUGGESTIONS, make_error_detail"`
2. Schema test: `python -c "from app.api.schemas import ErrorDetail, ErrorResponse"`
3. App imports: `python -c "from app.main import app"`
4. Unit tests pass: `pytest tests/ -v --tb=short`
</verification>

<success_criteria>
- ErrorCode enum contains all error codes from RESEARCH.md taxonomy
- ERROR_SUGGESTIONS provides actionable hint for every ErrorCode
- make_error_detail helper produces correct structure
- Global exception handlers format all errors consistently
- Existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-results-error-handling/05-01-SUMMARY.md`
</output>
